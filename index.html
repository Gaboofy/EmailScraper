<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Scraper Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
        }
        .drop-zone {
            border: 2px dashed #4b5563;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.active {
            border-color: #6b7280;
            background-color: rgba(75, 85, 99, 0.1);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .custom-btn {
            background-color: #2d3748;
            transition: all 0.2s ease;
        }
        .custom-btn:hover {
            background-color: #4a5568;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            border: 1px solid #333;
        }
        th {
            background-color: #2d3748;
        }
        tr:nth-child(even) {
            background-color: #1a1a1a;
        }
        code {
            background-color: #1a1a1a;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-family: monospace;
        }
        .sample-csv {
            font-family: monospace;
            background-color: #1a1a1a;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-2xl md:text-3xl font-bold mb-2">Email Scraper Dashboard</h1>
            <p class="text-gray-400">Upload your high school CSV data to find coach emails</p>
        </header>

        <div class="bg-gray-900 rounded-lg p-6 mb-8 shadow-lg">
            <h2 class="text-xl font-semibold mb-4">CSV Format Instructions</h2>
            <div class="mb-6">
                <p class="mb-3">Your CSV file must include these columns (the exact column names are important):</p>
                <ul class="list-disc pl-5 mb-4 space-y-1">
                    <li><code>School</code> - The name of the high school</li>
                    <li><code>City</code> - The city where the school is located</li>
                </ul>
                
                <p class="mb-3">Sample CSV format:</p>
                <div class="sample-csv mb-4">School,City
Lincoln High School,Portland
Washington High,Seattle
Roosevelt Academy,Chicago</div>
                
                <div class="flex justify-between mb-4">
                    <button id="download-sample" class="py-2 px-4 rounded-md custom-btn text-sm font-medium">
                        Download Sample CSV
                    </button>
                    <button id="view-advanced" class="py-2 px-4 rounded-md bg-transparent border border-gray-600 text-gray-300 hover:bg-gray-800 text-sm font-medium">
                        View Advanced Options
                    </button>
                </div>
                
                <div id="advanced-options" class="hidden bg-gray-800 p-4 rounded-md mb-4">
                    <h3 class="font-medium mb-2">Advanced CSV Options</h3>
                    <p class="mb-2">If your CSV has different column names, you can map them:</p>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm mb-1">School column name:</label>
                            <input type="text" id="school-column" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600" placeholder="e.g. Institution">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">City column name:</label>
                            <input type="text" id="city-column" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600" placeholder="e.g. Location">
                        </div>
                    </div>
                    <p class="text-xs text-gray-400">Leave blank to use default column names (School, City)</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-6 mb-8 shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Upload CSV File</h2>
            <div id="drop-zone" class="drop-zone p-8 text-center cursor-pointer mb-4">
                <div class="mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <p class="text-lg font-medium">Drag & drop your CSV file here</p>
                <p class="text-sm text-gray-400 mt-1">or</p>
                <button id="browse-btn" class="mt-2 px-4 py-2 text-sm font-medium rounded-md custom-btn">
                    Browse Files
                </button>
                <input type="file" id="file-input" accept=".csv" class="hidden">
                <p class="mt-3 text-xs text-gray-500">CSV should contain columns for school name and city</p>
            </div>
            
            <div id="file-info" class="hidden mb-4 p-3 bg-gray-800 rounded-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p id="file-name" class="font-medium"></p>
                        <p id="file-size" class="text-sm text-gray-400"></p>
                    </div>
                    <button id="remove-file" class="text-red-400 hover:text-red-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <button id="upload-btn" class="w-full py-3 px-4 rounded-md bg-indigo-700 hover:bg-indigo-600 text-white font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Send to Email Scraper
            </button>
        </div>

        <div id="csv-preview" class="hidden bg-gray-900 rounded-lg p-6 mb-8 shadow-lg">
            <h2 class="text-xl font-semibold mb-4">CSV Preview</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead id="preview-header">
                        <!-- Headers will be populated here -->
                    </thead>
                    <tbody id="preview-body">
                        <!-- Preview rows will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4">
                <p id="preview-status" class="text-sm text-gray-400"></p>
            </div>
        </div>

        <div id="progress-container" class="hidden bg-gray-900 rounded-lg p-6 mb-8 shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Processing Status</h2>
            <div class="mb-2 flex justify-between">
                <span>Progress</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="progress-bar bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="status-message" class="mt-3 text-center text-gray-400">Sending data to n8n workflow...</p>
        </div>

        <div id="completion-container" class="hidden bg-gray-900 rounded-lg p-6 shadow-lg">
            <div class="text-center py-6">
                <div class="mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h2 class="text-xl font-semibold mb-2">Data Successfully Sent!</h2>
                <p class="text-gray-400 mb-6">Your data has been sent to the email scraper workflow.</p>
                <p class="text-gray-400 mb-6">The n8n workflow will process your data and generate coach emails.</p>
                <button id="new-upload-btn" class="py-3 px-6 rounded-md bg-indigo-700 hover:bg-indigo-600 text-white font-medium">
                    Process Another File
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // HARDCODED WEBHOOK URL - Replace this with your actual n8n webhook URL
            const WEBHOOK_URL = "https://sebvas37.app.n8n.cloud/webhook/scraper";
            
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const browseBtn = document.getElementById('browse-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const removeFile = document.getElementById('remove-file');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const statusMessage = document.getElementById('status-message');
            const completionContainer = document.getElementById('completion-container');
            const newUploadBtn = document.getElementById('new-upload-btn');
            const viewAdvancedBtn = document.getElementById('view-advanced');
            const advancedOptions = document.getElementById('advanced-options');
            const schoolColumnInput = document.getElementById('school-column');
            const cityColumnInput = document.getElementById('city-column');
            const downloadSampleBtn = document.getElementById('download-sample');
            const csvPreview = document.getElementById('csv-preview');
            const previewHeader = document.getElementById('preview-header');
            const previewBody = document.getElementById('preview-body');
            const previewStatus = document.getElementById('preview-status');
            
            let csvFile = null;
            let parsedData = [];
            let csvHeaders = [];

            // Toggle advanced options
            viewAdvancedBtn.addEventListener('click', () => {
                advancedOptions.classList.toggle('hidden');
                viewAdvancedBtn.textContent = advancedOptions.classList.contains('hidden') 
                    ? 'View Advanced Options' 
                    : 'Hide Advanced Options';
            });

            // Download sample CSV
            downloadSampleBtn.addEventListener('click', () => {
                const sampleCsv = 'School,City\nLincoln High School,Portland\nWashington High,Seattle\nRoosevelt Academy,Chicago';
                const blob = new Blob([sampleCsv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('hidden', '');
                a.setAttribute('href', url);
                a.setAttribute('download', 'sample_schools.csv');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            // Event listeners for drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropZone.classList.add('active');
            }

            function unhighlight() {
                dropZone.classList.remove('active');
            }

            dropZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            browseBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        csvFile = file;
                        displayFileInfo(file);
                        previewCSV(file);
                        uploadBtn.disabled = false;
                    } else {
                        alert('Please select a valid CSV file.');
                    }
                }
            }

            function displayFileInfo(file) {
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.classList.remove('hidden');
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function previewCSV(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    
                    if (lines.length === 0) {
                        previewStatus.textContent = 'Error: CSV file appears to be empty';
                        return;
                    }
                    
                    // Get headers
                    csvHeaders = lines[0].split(',').map(header => header.trim());
                    
                    // Create header row
                    previewHeader.innerHTML = '';
                    const headerRow = document.createElement('tr');
                    csvHeaders.forEach(header => {
                        const th = document.createElement('th');
                        th.className = 'px-4 py-2 text-left';
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                    previewHeader.appendChild(headerRow);
                    
                    // Create preview rows (up to 5)
                    previewBody.innerHTML = '';
                    const maxRows = Math.min(5, lines.length - 1);
                    for (let i = 1; i <= maxRows; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const row = document.createElement('tr');
                        const values = lines[i].split(',').map(value => value.trim());
                        
                        values.forEach((value, index) => {
                            if (index < csvHeaders.length) {
                                const td = document.createElement('td');
                                td.className = 'px-4 py-2 border-b border-gray-800';
                                td.textContent = value;
                                row.appendChild(td);
                            }
                        });
                        
                        previewBody.appendChild(row);
                    }
                    
                    // Check for required columns
                    const schoolColName = schoolColumnInput.value.trim() || 'School';
                    const cityColName = cityColumnInput.value.trim() || 'City';
                    
                    const hasSchoolCol = csvHeaders.some(h => h.toLowerCase() === schoolColName.toLowerCase());
                    const hasCityCol = csvHeaders.some(h => h.toLowerCase() === cityColName.toLowerCase());
                    
                    if (!hasSchoolCol || !hasCityCol) {
                        previewStatus.innerHTML = `<span class="text-yellow-400">Warning:</span> Could not find required columns. ` +
                            `Expected <code>${schoolColName}</code> and <code>${cityColName}</code>. ` +
                            `Please check your CSV format or use the advanced options to specify column names.`;
                    } else {
                        previewStatus.innerHTML = `<span class="text-green-400">CSV format looks good!</span> Found ${lines.length - 1} schools.`;
                    }
                    
                    csvPreview.classList.remove('hidden');
                };
                reader.readAsText(file);
            }

            removeFile.addEventListener('click', () => {
                csvFile = null;
                fileInfo.classList.add('hidden');
                csvPreview.classList.add('hidden');
                fileInput.value = '';
                uploadBtn.disabled = true;
            });

            uploadBtn.addEventListener('click', processCSV);

            function processCSV() {
                if (!csvFile) {
                    alert('Please select a CSV file first.');
                    return;
                }

                // Parse CSV
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    const schoolColName = schoolColumnInput.value.trim() || 'School';
                    const cityColName = cityColumnInput.value.trim() || 'City';
                    
                    parsedData = parseCSV(csv, schoolColName, cityColName);
                    
                    if (parsedData.length === 0) {
                        alert('No data found in CSV or invalid format.');
                        return;
                    }

                    // Show progress container
                    progressContainer.classList.remove('hidden');
                    csvPreview.classList.add('hidden');
                    
                    // Send data to webhook
                    sendToWebhook(parsedData);
                };
                reader.readAsText(csvFile);
            }

            function parseCSV(csv, schoolColName, cityColName) {
                const lines = csv.split('\n');
                const result = [];
                
                if (lines.length === 0) return result;
                
                const headers = lines[0].split(',').map(header => header.trim());
                
                // Find column indices
                const schoolIndex = headers.findIndex(h => 
                    h.toLowerCase() === schoolColName.toLowerCase());
                const cityIndex = headers.findIndex(h => 
                    h.toLowerCase() === cityColName.toLowerCase());
                
                if (schoolIndex === -1 || cityIndex === -1) {
                    alert(`Could not find required columns: "${schoolColName}" and "${cityColName}". Please check your CSV format.`);
                    return [];
                }

                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',').map(value => value.trim());
                    
                    if (values.length <= Math.max(schoolIndex, cityIndex)) {
                        console.warn(`Line ${i} has fewer columns than expected`);
                        continue;
                    }
                    
                    const school = values[schoolIndex];
                    const city = values[cityIndex];
                    
                    if (school && city) {
                        result.push({ school, city });
                    }
                }
                
                return result;
            }

            function sendToWebhook(data) {
                // In a real implementation, you would send the data to your webhook
                // For now, we'll simulate the process with a progress bar
                
                let processed = 0;
                const total = data.length;
                const batchSize = 10; // Number of records to send in each batch
                const batches = Math.ceil(total / batchSize);
                
                statusMessage.textContent = `Sending data to n8n workflow (0/${total} schools)...`;
                
                // Process in batches
                for (let i = 0; i < batches; i++) {
                    const start = i * batchSize;
                    const end = Math.min(start + batchSize, total);
                    const batch = data.slice(start, end);
                    
                    // Simulate sending batch with delay
                    setTimeout(() => {
                        // In a real implementation, you would make an actual fetch request:
                        /*
                        fetch(WEBHOOK_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ schools: batch })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Update progress after successful batch
                            processed += batch.length;
                            updateProgress(processed, total);
                        })
                        .catch(error => {
                            console.error('Error sending batch:', error);
                            // Still update progress even if there was an error
                            processed += batch.length;
                            updateProgress(processed, total);
                        });
                        */
                        
                        // For demonstration, we'll simulate a successful batch
                        processed += batch.length;
                        
                        // Update progress
                        const percentage = Math.round((processed / total) * 100);
                        progressBar.style.width = `${percentage}%`;
                        progressPercentage.textContent = `${percentage}%`;
                        statusMessage.textContent = `Sending data to n8n workflow (${processed}/${total} schools)...`;
                        
                        if (processed >= total) {
                            // All data sent
                            setTimeout(() => {
                                statusMessage.textContent = 'All data successfully sent to n8n workflow!';
                                setTimeout(showCompletion, 1000);
                            }, 500);
                        }
                    }, 1000 + (i * 500)); // Stagger the batches for visual effect
                }
            }

            function showCompletion() {
                progressContainer.classList.add('hidden');
                completionContainer.classList.remove('hidden');
            }

            newUploadBtn.addEventListener('click', resetForm);

            function resetForm() {
                csvFile = null;
                parsedData = [];
                fileInfo.classList.add('hidden');
                csvPreview.classList.add('hidden');
                fileInput.value = '';
                uploadBtn.disabled = true;
                progressContainer.classList.add('hidden');
                completionContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
                statusMessage.textContent = 'Sending data to n8n workflow...';
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966eb71090792b64',t:'MTc1MzgxNDExNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
